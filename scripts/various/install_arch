#!/bin/bash

# Idea inspired by Yannick Vollenberg <https://nordri.vollenberg.ca>

# Colors
nc=$'\e[0;m';
g=$'\e[1;32m';
r=$'\e[0;31m';

description() {
    clear
    setfont sun12x22
    cat << EOF
    # French
    ${g}Ce script va installer une Archlinux en UEFI sur le premier disque détecté,
    cfdisk sera utilisé pour Le partitionnement qui n'est pas automatisé.${nc}
    
    # English
    ${g}This script will install Archlinux in UEFI mode on the first detected disk.
    Partitioning will be done using cfdisk and it's not automatic.
    
    Partitions layout:${nc}
    sda1=/boot/efi sda2=/ sda3=/home
EOF
    sleep 7s
}

install() {
    clear
    local HWDISK SDISK LOCATION TIMEZONE A B C
    
    HWDISK=$(lsblk -r | awk '/disk/{ NR==1; print $1 }')
    SDISK="/dev/$HWDISK"
    LOCATION=$(curl --fail -s https://ipapi.co/country)
    TIMEZONE=$(curl --fail -s https://ipapi.co/timezone)
    A="1" B="2" C="3"
    
    if [[ $(id -u) == 0 ]]; then
        # Setting faster packages downloads.
        sed -i 's/#ParallelDownloads/ParallelDownloads/' /etc/pacman.conf
        
        if [[ -n $(ls /sys/firmware/efi/efivars) ]]; then
            echo " ${g}Success, UEFI system detected.${nc}"
            sleep 2s
            timedatectl set-ntp true && timedatectl \
            && echo " ${g}Success, system clock updated.${nc}"
            sleep 2s
            
            cfdisk $SDISK
            
            echo " ${g}formatting and mounting partitions.${nc}"
            sleep 1s
            
            mkfs.fat -F32 $SDISK$A && mkfs.ext4 $SDISK$B && mkfs.ext4 $SDISK$C \
            && mount $SDISK$B /mnt \
            && mkdir -p /mnt/{boot/efi,home} \
            && mount $SDISK$A /mnt/boot/efi \
            && mount $SDISK$C /mnt/home \
            && lsblk && sleep 2s
            
            echo " ${g}Getting fresh mirrors list for $LOCATION...${nc}"
            sleep 1s
            
            reflector --verbose --country "$LOCATION" --latest 10 --age 24 \
            --protocol https --sort rate --save /etc/pacman.d/mirrorlist
            
            echo " ${g}Installing base system...${nc}"
            sleep 1s
            
            # pacstrap will not use the iso's archlinux-keyring.
            pacstrap -K /mnt base base-devel linux linux-headers linux-firmware \
            pacman-contrib grub efibootmgr os-prober gptfdisk fatresize networkmanager \
            reflector zip unzip p7zip nano wget vim mc git syslog-ng mtools usbutils \
            dosfstools lsb-release exfat-utils bash-completion man-db man-pages \
            xf86-input-{elographics,evdev,libinput,synaptics,vmmouse,void,wacom} \
            xf86-video-{amdgpu,ati,dummy,fbdev,intel,nouveau,openchrome,qxl,sisusb,vesa}
            
            cat /etc/pacman.d/mirrorlist > /mnt/etc/pacman.d/mirrorlist
            cat /etc/pacman.conf > /mnt/etc/pacman.conf
            
            echo " ${g}Generating fstab...${nc}"
            genfstab -U -p /mnt >> /mnt/etc/fstab \
            && sleep 2s && {
            
            echo ""
            read -r -p "${g}"' Please fill the machine name: '"${nc}" machine
            echo ""
            read -r -p "${g}"' What is your language: [F]rench (France), [E]nglish (US) '"${nc}" language
            case "$language" in
                f|F) lang="LANG=fr_FR.UTF-8" ;;
                e|E) lang="LANG=en_US.UTF-8" ;;
            esac
            echo ""
            read -r -p "${g}"' What is your keyboard layout: [F]rench (fr), [E]nglish (US) '"${nc}" keymap
            case "$keymap" in
                f|F) key="KEYMAP=fr-latin9"
                     font="FONT=eurlatgr"
                 ;;  
                e|E) key="KEYMAP=us"
                     font="FONT=lat2-16"
                 ;;  
            esac
            }
            
            arch-chroot /mnt /bin/bash -c "
                ln -sf /usr/share/zoneinfo/$TIMEZONE /etc/localtime \
                && hwclock --systohc --utc \
                && echo $machine > /etc/hostname \
                && echo $key > /etc/vconsole.conf \
                && echo $font >> /etc/vconsole.conf \
                && echo ' Choose your locales using nano' && sleep 2s \
                && nano /etc/locale.gen && locale-gen \
                && echo $lang > /etc/locale.conf \
                && echo LC_COLLATE=C >> /etc/locale.conf \
                && echo '127.0.0.1    localhost' > /etc/hosts \
                && echo '::1          localhost' >> /etc/hosts \
                && echo '127.0.1.1    $machine.localdomain    $machine' >> /etc/hosts \
                && mkinitcpio -p linux && clear \
                && echo ' Change the $USER password: ' \
                && passwd $USER && echo '' \
                && echo ' Installing grub menu on first sector of $SDISK, please be patient...' \
                && grub-install --target=xf86_64-efi --efi-directory=/boot/efi \
                --bootloader-id=ARCH_GRUB && grub-mkconfig -o /boot/grub/grub.cfg \
                && systemctl enable NetworkManager \
                && exit
            "
            clear
            read -r -p "${g}"' Do you want to enter the new installed system? [Y/n] ' enter
            case "$enter" in
                y|Y) arch-chroot /mnt ;;
                n|N) umount -R /mnt && reboot ;;
            esac
        else
            clear
            echo ""
            echo " ${r}NON UEFI system${nc}"
            sleep 3s && exit 0
        fi
    else
        clear
        echo ""
        echo " ${r}ONLY ROOT USER CAN RUN THIS SCRIPT.${nc}"
        sleep 3s && exit 0
    fi
    
}

description
install
