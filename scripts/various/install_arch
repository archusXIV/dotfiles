#!/bin/bash

# Author: Barret E <https://github.com/archusXIV/>
# Creation date: 2025-05-25
# License: GPLv2
# This script automates the installation of Arch Linux with the following features:
# - Supports both UEFI and BIOS systems
# - Configurable disk partitioning with option for separate /home partition
# - Customizable keyboard layout, locale, timezone and hostname
# - Automatic mirror selection based on response rate and package database update
# - Installation of base system packages (minimal) and bootloader
# - Network configuration via NetworkManager
# - Root password setup during installation
# - Safety checks for live environment and internet connectivity

# Display usage information if no arguments provided
if [ $# -eq 0 ]; then
    cat <<'USAGE'
 Arch Linux Installation Script
 ==============================

 Available options:
  -x all              List all present disks for decision making
  -c <country>        Set your actual location (default: United States)
  -d <root disk>      Set the system disk (default: sda)
  -k <kbd layout>     Set your keyboard layout (default: us)
  -l <locale>         Set system locale (default: en_US)
  -s <home disk>      Set the disk for /home (optional)
  -t <Region/Capital> Set timezone (default: UTC)
  -h <name>           Set hostname (default: archlinux)

 Example usage:
  $(basename "$0") -d sda -s sdb -k fr -l fr_FR -t Europe/Paris -h myarch

USAGE
    exit 1
fi

# Parse command line arguments
while getopts "x:c:d:k:l:t:h:s:" opt; do
    case $opt in
        x)
            echo -e " \nAvailable disks:\n"
            lsblk -d -n -p -o NAME,SIZE,MODEL
            echo ""
            exit 0
        ;;
        c) country="$OPTARG" ;;
        d) system_disk="$OPTARG" ;;
        k) keyboard_layout="$OPTARG" ;;
        l) locale="$OPTARG" ;;
        t) timezone="$OPTARG" ;;
        h) hostname="$OPTARG" ;;
        s) second_disk="$OPTARG" ;;
        \?) echo "Invalid option -$OPTARG" >&2; exit 1 ;;
    esac
done

# Set defaults if not provided
country=${country:-"United States"}
disk=${system_disk:-sda}
hostname=${hostname:-archlinux}
keyboard_layout=${keyboard_layout:-us}
locale=${locale:-en_US}
timezone=${timezone:-UTC}

checkUefi() {
    if [[ -d /sys/firmware/efi ]]; then
        echo "System is booted in UEFI mode"
        return 0
    else
        echo "System is booted in BIOS mode"
        return 1
    fi
}

ensureDiskPathsAreComplete() {
    [[ ! $disk =~ ^\/dev\/ ]] && disk="/dev/$disk"
    [[ -n $second_disk ]] && [[ ! $second_disk =~ ^\/dev\/ ]] \
    && second_disk="/dev/$second_disk"
}

errorDisk() {
    case "$1" in
        "clear_partition") echo "Error: Failed to clear partition table" ;;
        "create_efi") echo "Error: Failed to create EFI partition" ;;
        "create_efi_mount") echo "Error: Failed to create EFI mount point" ;;
        "create_root") echo "Error: Failed to create root partition" ;;
        "create_home") echo "Error: Failed to create home partition" ;;
        "create_home_mount") echo "Error: Failed to create home mount point" ;;
        "create_swap") echo "Error: Failed to create swap partition" ;;
        "disk_not_exist") echo "Error: Disk does not exist" ;;
        "enable_swap") echo "Error: Failed to enable swap" ;;
        "format_efi") echo "Error: Failed to format EFI partition" ;;
        "format_root") echo "Error: Failed to format root partition" ;;
        "format_home") echo "Error: Failed to format home partition" ;;
        "mount_root") echo "Error: Failed to mount root partition" ;;
        "mount_efi") echo "Error: Failed to mount EFI partition" ;;
        "mount_home") echo "Error: Failed to mount home partition" ;;
    esac
    exit 1
}

partitionDisk() {
    local is_uefi="$1"
    local disk="$2"
    local second_disk="$3"

    ensureDiskPathsAreComplete

    # Verify disks exist and clear partition tables
    for d in "$disk" ${second_disk:+"$second_disk"}; do
        [[ ! -b $d ]] && errorDisk "disk_not_exist"
        sgdisk -Z "$d" || errorDisk "clear_partition"
    done

    if [[ $is_uefi -eq 0 ]]; then
        # UEFI partitioning
        sgdisk -n 1:0:+512M -t 1:ef00 -c 1:"EFI System" "$disk" \
        || errorDisk "create_efi"
        sgdisk -n 2:0:0 -t 2:8300 -c 2:"Linux root" "$disk" \
        || errorDisk "create_root"

        if [[ -n $second_disk ]]; then
            sgdisk -n 1:0:0 -t 1:8300 -c 1:"Linux home" "$second_disk" \
            || errorDisk "create_home"
        fi
    else
        # BIOS partitioning
        sgdisk -n 1:0:+4G -t 1:8200 -c 1:"Linux swap" "$disk" \
        || errorDisk "create_swap"
        sgdisk -n 2:0:0 -t 2:8300 -c 2:"Linux root" "$disk" \
        || errorDisk "create_root"

        [[ -n $second_disk ]] && {
            sgdisk -n 1:0:0 -t 1:8300 -c 1:"Linux home" "$second_disk" \
            || errorDisk "create_home"
        }
    fi
}

setupPartitions() {
    local disk="$1"
    local is_uefi="$2"
    local second_disk="$3"

    ensureDiskPathsAreComplete

    if [[ $is_uefi -eq 0 ]]; then
        mkfs.fat -F32 "${disk}1" || errorDisk "format_efi"
        mkfs.ext4 "${disk}2" || errorDisk "format_root"

        mount "${disk}2" /mnt || errorDisk "mount_root"
        mkdir -p /mnt/boot/efi || errorDisk "create_efi_mount"
        mount "${disk}1" /mnt/boot/efi || errorDisk "mount_efi"

        [[ -n $second_disk ]] && {
            mkfs.ext4 "${second_disk}1" || errorDisk "format_home"
            mkdir -p /mnt/home || errorDisk "create_home_mount"
            mount "${second_disk}1" /mnt/home || errorDisk "mount_home"
        }
    else
        mkswap "${disk}1" || errorDisk "create_swap"
        mkfs.ext4 "${disk}2" || errorDisk "format_root"

        mount "${disk}2" /mnt || errorDisk "mount_root"
        swapon "${disk}1" || errorDisk "enable_swap"

        [[ -n $second_disk ]] && {
            mkfs.ext4 "${second_disk}1" || errorDisk "format_home"
            mkdir -p /mnt/home || errorDisk "create_home_mount"
            mount "${second_disk}1" /mnt/home || errorDisk "mount_home"
        }
    fi
}

installBaseSystem() {
    # Ensure the system clock is synchronized
    timedatectl set-ntp true
    # Update package database first
    reflector \
    -c "${country}" \
    -l 10 \
    -a 24 \
    -p https \
    --sort rate \
    --save /etc/pacman.d/mirrorlist
    pacman -Syy archlinux-keyring --noconfirm
    pacstrap -K /mnt base base-devel linux linux-firmware vim zram-generator
    genfstab -U /mnt >> /mnt/etc/fstab
    cp -f /etc/pacman.d/mirrorlist /mnt/etc/pacman.d/mirrorlist
}

configureSystem() {
    local is_uefi="$1"
    local system_disk="$2"

    # Create configuration script
cat > /mnt/root/configure.sh <<-EOF
#!/bin/bash
# Set timezone
ln -sf /usr/share/zoneinfo/"$timezone" /etc/localtime
hwclock --systohc --utc

# Set locale
sed -i "s/#${locale}/${locale}/" /etc/locale.gen
locale-gen
echo "LANG=$locale" > /etc/locale.conf
echo "LC_COLLATE=C" >> /etc/locale.conf
export LANG="$locale.UTF-8"

# Set hostname
echo "$hostname" > /etc/hostname
echo "127.0.1.1    $hostname.localdomain    $hostname" >> /etc/hosts

# Set keyboard layout
echo "KEYMAP=$keyboard_layout" > /etc/vconsole.conf
mkinitcpio -P

# Configure network
pacman -S --noconfirm networkmanager
systemctl enable NetworkManager

# Set root password
echo "Set root password:"
passwd

# Install and configure bootloader
if [[ $is_uefi -eq 0 ]]; then
    pacman -S --noconfirm grub efibootmgr
    grub-install --target=x86_64-efi --efi-directory=/boot/efi --bootloader-id=ARCH_GRUB
else
    pacman -S --noconfirm grub
    [[ -z "$system_disk" || ! -b "$system_disk" ]] && {
        echo "Error: Invalid or unset system disk for BIOS bootloader installation."
        exit 1
    }
    grub-install --target=i386-pc "$system_disk"
fi
grub-mkconfig -o /boot/grub/grub.cfg

exit  # Exit chroot
EOF

    chmod +x /mnt/root/configure.sh
    if ! arch-chroot /mnt /root/configure.sh; then
        echo "Error: Configuration script failed. Retaining /mnt/root/configure.sh for debugging."
    else
        rm /mnt/root/configure.sh
    fi
}

# We start from here
echo -e "\nStarting Arch Linux installation...\n"

# Verify we're in the live environment
if [[ ! -f /run/archiso/bootmnt/arch/boot/x86_64/vmlinuz-linux ]]; then
    echo "This script must be run from the Arch Linux live environment!"
    exit 1
fi

# Check internet connectivity
ping -c 1 archlinux.org >/dev/null 2>&1 || {
    echo "No internet connection! Please connect to the internet first."
    exit 1
}

# Check UEFI status
checkUefi
is_uefi=$?

# Confirm installation
echo "WARNING: This will erase ALL data on $system_disk"
read -rp "Do you want to continue? (y/N) " confirm
[[ ! $confirm =~ ^[Yy]$ ]] && {
    echo "Installation cancelled."
    exit 1
}

# Perform disks operations
if [[ -n $second_disk ]]; then
    echo "Partitioning disks..."
    partitionDisk "$is_uefi" "$system_disk" "$second_disk"
    echo "Setting up partitions..."
    setupPartitions "$system_disk" "$is_uefi" "$second_disk"
else
    echo "Formatting disk..."
    partitionDisk "$is_uefi" "$system_disk"
    echo "Setting up partitions..."
    setupPartitions "$system_disk" "$is_uefi"
fi

echo "Installing base system..."
installBaseSystem

echo "Configuring system..."
configureSystem "$is_uefi" "$system_disk"

echo "Unmounting partitions..."
umount -R /mnt

echo -e "\nInstallation complete!"
echo "You can now reboot into your new Arch Linux system."
echo "After reboot, log in as root with the password you set."
