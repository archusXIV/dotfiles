#!/bin/bash

# COULEURS
nc='\e[0;m'
g='\e[1;32m'
r='\e[0;31m'

install() {
    
    local HWDISK LOCATION TIMEZONE
    HWDISK=$(lsblk -r | awk '/disk/{print $1}' | sed -n '1p')
    LOCATION=$(curl --fail -s https://ipapi.co/country)
    TIMEZONE=$(curl --fail https://ipapi.co/timezone)
    
    if [[ $(id -u) == 0 ]]; then
        # setting faster packages downloads
        sed -i 's/#ParallelDownloads/ParallelDownloads/' /etc/pacman.conf
        
        if [[ -n $(ls /sys/firmware/efi/efivars) ]]; then
            echo -e " ${g}Success${nc}, UEFI system detected."
            sleep 2s
            timedatectl set-ntp true && timedatectl \
            && echo -e " ${g}Success${nc}, system  clock updated."
            sleep 2s
            
            cfdisk /dev/$HWDISK
            
            echo " ${g}Formating and mounting partitions...${nc}"
            sleep 1s

            mkfs.fat -F32 $HWDISK1 && mkfs.ext4 $HWDISK2 && mkfs.ext4 $HWDISK3 \
            && mount $HWDISK2 /mnt \
            && mkdir -p /mnt/{boot/efi,home} \
            && mount $HWDISK1 /mnt/boot/efi \
            && mount $HWDISK3 /mnt/home \
            && lsblk && sleep 1s
            
            echo -e " ${g}Getting fresh mirrors list for $LOCATION${nc}"
            sleep 1s
            
            reflector --verbose -c "$LOCATION" --latest 10 --age 24 --protocol https \
            --sort rate --save /etc/pacman.d/mirrorlist
            
            echo -e " ${g}Installing base system...${nc}"
            sleep 1s
            
            pacstrap -K /mnt base base-devel linux linux-headers linux-firmware \
            pacman-contrib grub efibootmgr os-prober networkmanager reflector \
            zip unzip p7zip vi nano wget vim mc git syslog-ng mtools usbutils \
            dosfstools lsb-release exfat-utils bash-completion man-db man-pages \
            xf86-video-{amdgpu,ati,dummy,fbdev,intel,nouveau,openchrome,qxl,sisusb,vesa}
            
            cat /etc/pacman.d/mirrorlist > /mnt/etc/pacman.d/mirrorlist
            
            echo " ${g}Generating sftab...${nc}"
            genfstab -U -p /mnt >> /mnt/etc/fstab
            sleep 2s
            
            echo -e "${g} Please fill the machine name:${nc}"
            read machine
            
            arch-chroot /mnt /bin/bash -c "
                ln -sf /usr/share/zoneinfo/$TIMEZONE /etc/localtime
                hwclock --systohc --utc
                echo $machine > /etc/hostname \
                && echo KEYMAP=fr-latin9 > /etc/vconsole.conf \
                && echo FONT=eurlatgr >> /etc/vconsole.conf \
                && echo Choisissez vos locales && sleep 2 \
                && nano /etc/locale.gen && locale-gen \
                && echo LANG=en_US.UTF-8 > /etc/locale.conf \
                && echo LC_COLLATE=C >> /etc/locale.conf
                
                echo 127.0.0.1    localhost >> /etc/hosts \
                echo ::1        localhost >> /etc/hosts \
                && echo 127.0.1.1    $machine.localdomain    $machine >> /etc/hosts
                
                mkinitcpio -p linux
                
                echo Change the $USER password:
                passwd $USER
                
                grub-install --target=x86_64-efi --efi-directory=/boot/efi \
                --bootloader-id=GRUB && grub-mkconfig -o /boot/grub/grub.cfg
                
                systemctl enable NetworkManager
                exit
            "
            read -p ' Do you want to enter the new installed system? [Y/n]' enter
            case "$enter" in
                y|Y) arch-chroot /mnt ;;
                n|N) umount -R /mnt && reboot ;;
            esac
            
        else
            clear
            echo ""
            echo -e "${r} MACHINE NON UEFI""${nc}"
            sleep 4s && exit 0
        fi
    fi

}

description() {
    clear
    cat << EOF
    Ce script va installer une Archlinux en UEFI sur le premier disque détecté,
    cfdisk sera utilisé pour Le partitionnement et n'est pas automatique.
    This script will install Archlinux in UEFI mode on the first detected disk,
    Partitioning will be done using cfdisk and it's not automatic.
    sda1=/boot/efi sda2=/ sda3=/home
EOF
    sleep 5s
}

description
install
