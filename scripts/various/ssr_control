#!/bin/bash

# simple script to run simplescreenrecorder in hidden mode
# for the entered time & @screen_position.

SSR_FIFO="$XDG_RUNTIME_DIR/ssr.fifo"
configs_path="$XDG_CONFIG_HOME/simplescreenrecorder/input-profiles"

_cleanup() {
    unset IFS
    rm "$SSR_FIFO"
    amixer set Capture,0 0%,0% mute nocap >/dev/null 2>&1
    polybar-msg action "#mic-ipc.hook.0" >/dev/null 2>&1
}

_usage() {
    echo " Usage:   ${0##*/} duration screen"
    echo " Example: ${0##*/} 00:15:30 {left,center,right,all}"
    echo " or:      ${0##*/} 15:30 {left,center,right,all}"
    [[ -p "$SSR_FIFO" ]] && _cleanup
    exit 1
}

if [[ $# -ne 2 ]]; then
    _usage
fi

if [[ -p "$SSR_FIFO" ]]; then
    rm "$SSR_FIFO" && mkfifo "$SSR_FIFO"
else
    mkfifo "$SSR_FIFO"
fi

amixer set Capture,0 80%,80% unmute cap >/dev/null 2>&1
polybar-msg action "#mic-ipc.hook.1" >/dev/null 2>&1

_timeConverdion() {
    convertString="$1"
    IFS=":";
    if [[ ${#convertString} -eq 5 ]]; then
        read -r minutes seconds <<< "$convertString"
        totalSeconds=$((minutes * 60 + seconds))
    elif [[ ${#convertString} -eq 8 ]]; then
        read -r hours minutes seconds <<< "$convertString"
        totalSeconds=$(((hours * 3600) + (minutes * 60 + seconds)))
    else
        _usage
    fi
    unset IFS
}

_ssrConfig() {
    simplescreenrecorder \
    --start-hidden \
    --settingsfile="$configs_path/$1.conf" < "$SSR_FIFO" &
}

# getting user input according to _usage function
while (($#)); do
    TIME="$1"
    case "$2" in
        all   ) _ssrConfig triplescreen ;;
        left  ) _ssrConfig screen1 ;;
        center) _ssrConfig screen2 ;;
        right ) _ssrConfig screen3 ;;
        *     ) _usage ;;
    esac
    break
done

_timeConverdion "$TIME"
# simplescreenrecorder commands
exec 4> "$SSR_FIFO"
sleep 1
echo "record-start" >&4
sleep "$totalSeconds"
echo "record-save" >&4
sleep 1
echo "quit" >&4
exec 4>&-

_cleanup
clear
exit
