#!/bin/bash

#    Author: Barret E (2021) <archus@protonmail.com>
#    Dependencies: fzf, pacdiff, reflector, vim.
#
#    This script shows a menu to let you choose over several pacman tools and options.
#    In order to install or remove packages it uses fzf utility on the fancy side.
#    We can also find and purge orphan packages, pacnew & pacsave files,
#    refresh our mirrorlist, purge the cache, edit pacman.conf/makepkg.conf and of course update the system.

color_off=$'\e[0m';
red=$'\e[0;31m';
green=$'\e[0;32m';

declare -a dependencies=( "fzf" "pacdiff" "reflector" "vim" "updates-viewer" )

for i in "${dependencies[@]}"; do
    [[ -z $(command -v "$i") ]] \
    && echo " ${red}Missing dependencies...$i" \
    && exit 1
done

_install() {
    sudo pacman -Sy >/dev/null 2>&1
    sudo pacman -Fy >/dev/null 2>&1
    pacman -Slq \
                | fzf --multi --preview 'cat <(sudo pacman -Si {1}) <(sudo pacman -Fl {1} | awk "{print \$2}")' \
                | xargs -ro sudo pacman -S
}

_uninstall() {
    pacman -Slq \
                | fzf --multi --preview  'cat <(sudo pacman -Si {1}) <(sudo pacman -Fl {1} | awk "{print \$2}")' \
                | xargs -ro sudo pacman -Rns
}

_orphans() {
    local pkgs
    pkgs="$XDG_CACHE_HOME"/orphans_list.txt
    echo ""
    if [[ -n $(pacman -Qtdq) ]]; then
        pacman -Qtdq > "$pkgs" && cat "$pkgs"
        echo ""
        echo " ${red}Would you like to purge orphan packages? [N/y]:${color_off}"
        read -r purge
        case "$purge" in
            N|n|no ) _menu
            ;;
            y|Y|yes) sudo pacman -Rdd $(pacman -Qtdq) && sudo paccache -ruk0
                     echo " ${green}A list of removed packages has been created \
                     in "$XDG_CACHE_HOME"/orphans_list.txt.${color_off}"
                     sleep 5s
            ;;
            *      ) _menu
            ;;
        esac
    else
        echo " ${green}No orphan package found.${color_off}"
        sleep 3s
        _menu
    fi
}

_pacdiff() {
    if [[ -z $(find /etc -regextype posix-extended -regex ".+\.pac(new|save)" 2> /dev/null) ]]; then
        echo " ${green}No pac{new,save} files found.${color_off}"
        sleep 3s
    else
        sudo pacdiff
    fi
}

_reflector() {
    PS3=""
    echo ""
    echo " ${green}Select your country:"
    echo " Example for France: 19"
    echo " More details in a terminal, type: ${color_off}reflector --list-countries"
    echo ""
    select country in $(reflector --list-countries \
        | sed '1d;2d;8d' \
        | sed 's/Hong Kong/Hong-Kong/;s/North Macedonia/North-Macedonia/' \
        | sed 's/New Caledonia/New-Caledonia/;s/New Zealand/New-Zealand/' \
        | sed 's/South Africa/South-Africa/;s/South Korea/South-Korea/' \
        | sed 's/United States/United-States/;s/United Kingdom/United-Kingdom/' \
        | awk '{print $1}'); do

        case "$country" in
            Hong-Kong      ) country='Hong Kong'       ;;
            New-Caledonia  ) country='New Caledonia'   ;;
            New-Zealand    ) country='New Zealand'     ;;
            North-Macedonia) country='North Macedonia' ;;
            South-Africa   ) country='South Africa'    ;;
            South-Korea    ) country='South Korea'     ;;
            United-Kingdom ) country='United Kingdom'  ;;
            United-States  ) country='United States'   ;;
        esac

        sudo reflector \
        --country "$country" \
        --verbose \
        --latest 10 \
        --age 24 \
        --protocol http \
        --protocol https \
        --sort rate \
        --save /etc/pacman.d/mirrorlist
        echo " ${green}New mirrorlist saved.${color_off}"
        sleep 3s
        break
    done
}

_menu() {
    clear
    while [[ -f /etc/pacman.conf ]]; do
        clear
        echo ""
        echo -e "                                           ::pacman options:: "
        echo -e "                       ┌───────────────────────────────────────────────────────────┐"
        echo -e "                       │    1) Search & Install          6) Update the system      │"
        echo -e "                       │    2) Uninstall a package(s)    7) Pacdiff                │"
        echo -e "                       │    3) List/Purge orphans        8) Edit pacman.conf       │"
        echo -e "                       │    4) Purge the cache           9) Edit makepkg.conf      │"
        echo -e "                       │    5) Update mirrors            0) Exit                   │"
        echo -e "                       └───────────────────────────────────────────────────────────┘"
        echo -e "                                             ${green}Select an item${color_off}"
        echo ""
        read -r option
        case $option in
            1)  _install
                echo ""
            ;;
            2)  _uninstall
                echo ""
            ;;
            3)  _orphans
                echo ""
            ;;
            4)  sudo pacman -Scc
                echo ""
            ;;
            5)  _reflector
                echo ""
            ;;
            6)  updates-viewer --list
                echo ""
            ;;
            7)  _pacdiff
                echo ""
            ;;
            8)  sudo vim /etc/pacman.conf
                echo ""
            ;;
            9)  sudo vim /etc/makepkg.conf
                echo ""
            ;;
            0)  clear
                exit
            ;;
            *)  echo -e " ${red} Wrong option!"
                echo " ${green}Wait and try again...${color_off}"
                echo ""
                sleep 3s
                clear
            ;;
        esac
    done
}

_menu
