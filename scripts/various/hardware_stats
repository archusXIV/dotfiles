#!/usr/bin/env bash

# Hardware utilizations and temperatures displayed in polybar.
# I had to include mpd stuff not to create another polybar module.
# Same thing for mpv...
# Dependencies: polybar FontAwesome.

# colored FontAwesome icons for polybar using ~/.Xresources parameters.
# pad is just a character that creates a kind of padding function,
# for simulated blocks or modules.
_icons_color() { xrdb -query | awk '/color3:/{print $NF}'; }
tc="%{F$(xrdb -query | awk '/color4:/{print $NF}')}"
pad="%{F$(xrdb -query | awk '/background:/{print $NF}')}_%{F-}"
icon_core="%{F$(_icons_color)}%{F-}"
icon_disk="%{F$(_icons_color)}%{F-}"
icon_fan="%{F$(_icons_color)}%{F-}"
icon_gputemp="%{F$(_icons_color)}%{F-}"
icon_home="%{F$(_icons_color)}%{F-}"
icon_mem="%{F$(_icons_color)}%{F-}"

_mpd() {
    # if ncmpcpp is running it will activate the same polybar module,
    # but if that is not the case...
    if pactl list sink-inputs | grep -wq 'mpd' && [[ -z $(pidof ncmpcpp) ]]; then
        polybar-msg \
        action "#player-ipc.hook.1" >/dev/null 2>&1
    fi
}

_coreusage() { cut -d ' ' -f1 /proc/loadavg; }
_coretemp() { sensors k10temp-pci-00c3 | awk '/Tctl/{ sub("[+]",""); print $2 }'; }
_gputemp() { sensors amdgpu-pci-0300 | awk '/edge:/{ sub("[+]",""); print $2 }'; }
_gpufanspeed() { sensors nct6687-isa-0a20 | awk '/fan1:/{ print $2" ""rpm" }'; }
_cpufanspeed() { sensors nct6687-isa-0a20 | awk '/fan2:/{ print $2" ""rpm" }'; }
_mem() { free -m | awk '/Mem:/{print ($2 - $4 - $6 + $5) " MiB"}'; }

_sysdisksusage() {
    if (( $(df -h | awk '/nvme0n1p2/{ sub("[%]",""); print $5 }') > 60 )); then
        echo "/: %{F#FF4747}$(df -h | awk '/nvme0n1p2/{print $5}')%{F-}"
    else
        df -h | awk '/nvme0n1p2/{print $5}'
    fi
}

_homedisksusage() {
    if (( $(df -h | awk '/nvme0n1p3/{ sub("[%]",""); print $5 }') > 85 )); then
        echo "- : %{F#FF4747}$(df -h | awk '/nvme0n1p3/{ sub("[%]",""); print $5 }')%{F-}"
    else
        df -h | awk '/nvme0n1p3/{print $5}'
    fi
}

# loop if the polybar module uses: tail = true
# while true; do
echo "${icon_core}${pad}${tc}$(_coreusage)% - $(_coretemp)${pad}\
${icon_gputemp}${pad}${tc}$(_gputemp)${pad}\
${icon_fan}${pad}${tc}$(_gpufanspeed)${pad}\
${icon_fan}${pad}${tc}$(_cpufanspeed)${pad}\
${icon_mem}${pad}${tc}$(_mem)${pad}\
${icon_disk}${pad}${tc}$(_sysdisksusage)${pad}\
${icon_home}${pad}${tc}$(_homedisksusage)"
eval _mpd
	# sleep 4
    # [[ -z $(pidof polybar) ]] && exit
# done
