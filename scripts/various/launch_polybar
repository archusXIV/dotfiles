#!/bin/bash

# Terminate already polybar instances.
# First try gracefully then the hard way.
sockets_dir="$XDG_RUNTIME_DIR/polybar/"

[[ -d $sockets_dir ]] && \
    polybar-msg cmd quit >/dev/null 2>&1 \
    || {
        rm /tmp/polybar_mqueue.* 2>/dev/null
        killall -q --signal SIGKILL {conky,polybar}
        rm -rf "$sockets_dir" 2>/dev/null
    }

# Wait until the process has been closed.
while pgrep -u "$UID" -x polybar; do
    sleep 0.5
done

bars=( "bspwm-bar-1" "bspwm-bar-2" "bspwm-bar-3" \
        "i3-bar-1" "i3-bar-2" "i3-bar-3" )

if [[ -n $(pidof bspwm) ]]; then
    unset {bars[3],bars[4],bars[5]}
    for b in "${bars[@]}"; do
        polybar "$b" -q & disown
    done
    notify-send 'Bars launched...'
    exit 0
elif [[ -n $(pidof i3) ]]; then
    unset {bars[0],bars[1],bars[2]}
    for b in "${bars[@]}"; do
        polybar "$b" -q & disown
    done
    notify-send 'Bars launched...'
    exit 0
fi
